<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Art Gallery</title>
    <style>
        body {
            font-family: sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
        }
        header {
            background-color: #333;
            color: #fff;
            padding: 1rem;
            text-align: center;
        }
        #gallery {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
            padding: 1rem;
        }
        .artwork {
            background-color: #fff;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        .artwork img {
            width: 100%;
            height: auto;
        }
        .artwork-info {
            padding: 1rem;
        }
        .artwork-title {
            font-size: 1.2rem;
            font-weight: bold;
        }
        .artwork-artist {
            font-size: 1rem;
            color: #666;
        }
    </style>
</head>
<body>
    <header>
        <h1>Art Gallery</h1>
        <p>A curated collection of art from The Metropolitan Museum of Art</p>
    </header>
    <main>
        <div id="gallery"></div>
        <div id="loading-indicator" style="text-align: center; padding: 2rem;">Loading...</div>
    </main>
    <script>
        const gallery = document.getElementById('gallery');
        const loadingIndicator = document.getElementById('loading-indicator');
        
        // Utility function to create timeout for fetch requests
        function fetchWithTimeout(url, timeout = 10000) {
            return Promise.race([
                fetch(url),
                new Promise((_, reject) => {
                    setTimeout(() => reject(new Error('Request timeout')), timeout);
                })
            ]);
        }
        
        // Utility function to safely parse JSON from localStorage
        function safeJSONParse(jsonString) {
            try {
                return JSON.parse(jsonString);
            } catch (error) {
                console.warn('Failed to parse cached data:', error);
                // Clear corrupted cache
                localStorage.removeItem('artworks');
                localStorage.removeItem('artworks_timestamp');
                return null;
            }
        }
        
        // Function to delay between requests to avoid overwhelming the API
        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        async function getArtworks() {
            try {
                // Check for cached data
                const cachedArtworks = localStorage.getItem('artworks');
                const cacheTimestamp = localStorage.getItem('artworks_timestamp');

                if (cachedArtworks && cacheTimestamp && (Date.now() - cacheTimestamp < 1000 * 60 * 60 * 24)) {
                    // Use cached data if it's less than a day old
                    const artworks = safeJSONParse(cachedArtworks);
                    if (artworks) {
                        displayArtworks(artworks);
                        return;
                    }
                }

                // Fetch new data
                loadingIndicator.style.display = 'block';
                gallery.innerHTML = '<p style="text-align: center; color: #666; padding: 2rem;">Loading artworks from The Met Museum...</p>';
                
                const response = await fetchWithTimeout('https://collectionapi.metmuseum.org/public/collection/v1/search?isHighlight=true&hasImages=true&q=painting');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                const objectIDs = data.objectIDs;

                if (!objectIDs || !Array.isArray(objectIDs) || objectIDs.length === 0) {
                    gallery.innerHTML = '<p style="text-align: center; color: #666; padding: 2rem;">No artworks found. The museum collection may be temporarily unavailable.</p>';
                    return;
                }

                // Fetch artwork details in smaller batches to avoid overwhelming the API
                const batchSize = 10;
                const maxArtworks = 30;
                const selectedIDs = objectIDs.slice(0, maxArtworks);
                const artworks = [];
                
                for (let i = 0; i < selectedIDs.length; i += batchSize) {
                    const batch = selectedIDs.slice(i, i + batchSize);
                    const batchPromises = batch.map(async (id) => {
                        try {
                            const res = await fetchWithTimeout(`https://collectionapi.metmuseum.org/public/collection/v1/objects/${id}`, 8000);
                            if (!res.ok) return null;
                            return await res.json();
                        } catch (error) {
                            console.warn(`Failed to fetch artwork ${id}:`, error);
                            return null;
                        }
                    });
                    
                    const batchResults = await Promise.all(batchPromises);
                    artworks.push(...batchResults.filter(artwork => artwork !== null));
                    
                    // Small delay between batches
                    if (i + batchSize < selectedIDs.length) {
                        await delay(500);
                    }
                }

                if (artworks.length === 0) {
                    gallery.innerHTML = '<p style="text-align: center; color: #666; padding: 2rem;">Unable to load artwork details. Please try again later.</p>';
                    return;
                }

                // Cache the new data
                try {
                    localStorage.setItem('artworks', JSON.stringify(artworks));
                    localStorage.setItem('artworks_timestamp', Date.now().toString());
                } catch (storageError) {
                    console.warn('Failed to cache artworks:', storageError);
                    // Continue without caching if storage is full
                }

                displayArtworks(artworks);

            } catch (error) {
                console.error('Error fetching artworks:', error);
                
                // Try to show cached data as fallback
                const cachedArtworks = localStorage.getItem('artworks');
                if (cachedArtworks) {
                    const artworks = safeJSONParse(cachedArtworks);
                    if (artworks) {
                        gallery.innerHTML = '<p style="text-align: center; color: #ff6b6b; padding: 1rem; background: #ffe6e6; border-radius: 5px; margin: 1rem;">⚠️ Showing cached artworks due to connection issues</p>';
                        displayArtworks(artworks);
                        return;
                    }
                }
                
                // Final fallback
                gallery.innerHTML = `
                    <div style="text-align: center; color: #666; padding: 3rem;">
                        <h3>Unable to load artworks</h3>
                        <p>There was an error connecting to The Metropolitan Museum API.</p>
                        <p style="font-size: 0.9em; color: #999;">Error: ${error.message}</p>
                        <button onclick="location.reload()" style="background: #333; color: white; padding: 0.5rem 1rem; border: none; border-radius: 3px; cursor: pointer; margin-top: 1rem;">Try Again</button>
                    </div>
                `;
            } finally {
                loadingIndicator.style.display = 'none';
            }
        }

        function displayArtworks(artworks) {
            gallery.innerHTML = '';
            
            if (!Array.isArray(artworks) || artworks.length === 0) {
                gallery.innerHTML = '<p style="text-align: center; color: #666; padding: 2rem;">No artworks to display.</p>';
                return;
            }
            
            let displayedCount = 0;
            
            artworks.forEach(artwork => {
                // Validate artwork data
                if (!artwork || typeof artwork !== 'object') {
                    return;
                }
                
                if (artwork.primaryImageSmall && artwork.title) {
                    const artworkElement = document.createElement('div');
                    artworkElement.classList.add('artwork');
                    
                    // Safely escape HTML content
                    const title = (artwork.title || 'Untitled').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                    const artist = (artwork.artistDisplayName || 'Unknown Artist').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                    const altText = `${title} by ${artist}`.replace(/"/g, '&quot;');
                    
                    artworkElement.innerHTML = `
                        <img src="${artwork.primaryImageSmall}" alt="${altText}" 
                             onerror="this.parentNode.style.display='none';"
                             onload="this.style.opacity='1';"
                             style="opacity: 0; transition: opacity 0.3s ease;">
                        <div class="artwork-info">
                            <div class="artwork-title">${title}</div>
                            <div class="artwork-artist">${artist}</div>
                            ${artwork.objectDate ? `<div style="font-size: 0.9em; color: #999; margin-top: 0.5rem;">${artwork.objectDate}</div>` : ''}
                        </div>
                    `;
                    gallery.appendChild(artworkElement);
                    displayedCount++;
                }
            });
            
            if (displayedCount === 0) {
                gallery.innerHTML = '<p style="text-align: center; color: #666; padding: 2rem;">No valid artworks found to display.</p>';
            }
        }

        // Initialize the gallery
        getArtworks();
    </script>
</body>
</html>
